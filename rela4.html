<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Jornada de um Atleta - Análise Automatizada (Relatório Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #1a202c;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }
        h1 {
            color: #2c5282;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2c5282;
            border-left: 4px solid #2c5282;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
        .table-container th, .table-container td {
            border-bottom: 1px solid #e2e8f0;
            padding: 0.5rem;
        }
        .card {
            background-color: #EBF8FF;
            padding: 1.5rem;
            border-radius: 10px;
        }
        .aspect-w-16 {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }
        .aspect-w-16 iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .btn-primary, .btn-example, .btn-accent, .btn-resync {
            background-color: #2c5282;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover, .btn-example:hover, .btn-accent:hover, .btn-resync:hover {
            background-color: #2b6cb0;
        }
        .btn-primary:disabled, .btn-accent:disabled, .btn-resync:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
         .btn-secondary {
            background-color: #4A5568;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-success {
            background-color: #10B981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-accent {
            background-color: #4c51bf;
        }
        .btn-accent:hover {
             background-color: #434190;
        }
        .btn-resync {
            background-color: #2c7a7b; /* Teal */
        }
        .btn-resync:hover {
            background-color: #285e61;
        }

        .editable-container {
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem;
            background-color: #f7fafc;
        }
        .editable-title, .editable-text, .editable-time, .editable-general-text, .editable-list-item-desc, .editable-table-cell, .editable-chart-value {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            background-color: #fff;
        }
        .editable-list-item-title {
             width: calc(100% - 1rem);
             padding: 0.5rem;
             margin-bottom: 0.5rem;
             border: 1px solid #cbd5e0;
             border-radius: 4px;
             background-color: #fff;
             font-weight: bold;
        }
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-input-group label {
            white-space: nowrap;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .hidden {
            display: none;
        }
        .chart-editor {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .chart-editor label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .chart-editor input {
            width: 60px;
            text-align: right;
        }
        .input-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            align-items: center;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center py-8">
        <h1 class="text-3xl md:text-5xl font-extrabold text-custom-blue mb-2">A Jornada de um Atleta</h1>
        <p class="text-lg text-gray-600">Relatório de Análise de Jogo - Tênis de Mesa</p>
    </header>

    <main>
        <section id="automated-analysis" class="section-container">
            <h2 class="section-title">Análise de Jogo</h2>
            <div class="input-group">
                <input type="password" id="api-key" placeholder="Cole sua Chave de API do Gemini aqui" value="AIzaSyCEbfAAbJ1KtR3hV-0fRrN9p4LZtZCvf0Q">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sm text-blue-600 whitespace-nowrap">Alterar Chave</a>
            </div>
            <div class="input-group">
                <input type="text" id="youtube-url" placeholder="Cole a URL do vídeo do YouTube aqui" class="flex-grow" value="https://www.youtube.com/watch?v=Iyaon7rUS-Q">
                <button id="load-video-btn" class="btn-primary">Carregar Vídeo</button>
            </div>
            <div class="input-group">
                <select id="player-level">
                    <option value="Iniciante">Iniciante</option>
                    <option value="Intermediário">Intermediário</option>
                    <option value="Avançado">Avançado</option>
                    <option value="Alto Rendimento" selected>Alto Rendimento</option>
                </select>
                <input type="text" id="additional-data" placeholder="Cor da camiseta, nome ou outro dado" class="flex-grow" value="camiseta rosa">
                <button id="process-evaluation-btn" class="btn-primary">Processar Análise</button>
            </div>
             <div id="video-player-container" class="mt-6 hidden">
                <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden">
                    <iframe id="video-player" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
        </section>

        <section id="analise-jogos" class="section-container">
            <h2 class="section-title">1. Estrutura da Análise de Jogos</h2>
            
            <textarea id="s1-intro" class="editable-general-text" rows="5">Aguardando processamento da análise...</textarea>
            
            <h3 class="font-bold text-xl my-4">Análise do Jogo</h3>

            <div class="card mb-6">
                <h3 id="s1-stage" class="font-bold text-lg mb-2 text-custom-blue">Estágio de Desenvolvimento</h3>
                <textarea id="s1-card-p1" class="editable-general-text" rows="3"></textarea>
                <textarea id="s1-card-p2" class="editable-general-text mt-4" rows="3"></textarea>
            </div>

            <div class="table-container overflow-x-auto mb-6">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-3 font-semibold text-gray-700">Pontos Fortes</th>
                            <th class="p-3 font-semibold text-gray-700">Pontos a Melhorar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r1-c1" rows="3"></textarea></td>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r1-c2" rows="3"></textarea></td>
                        </tr>
                        <tr>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r2-c1" rows="3"></textarea></td>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r2-c2" rows="3"></textarea></td>
                        </tr>
                        <tr>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r3-c1" rows="3"></textarea></td>
                            <td><textarea class="editable-table-cell" data-id="s1-t1-r3-c2" rows="3"></textarea></td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <label class="font-semibold text-sm text-gray-600">Comentário Final:</label>
            <textarea id="s1-final-comment" class="editable-general-text" rows="3"></textarea>
        </section>

        <section id="framework-desenvolvimento" class="section-container">
            <h2 class="section-title">2. Framework de Desenvolvimento do Atleta</h2>
            
            <textarea id="s2-intro" class="editable-general-text" rows="2"></textarea>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                <div class="card">
                    <h3 class="font-bold text-lg mb-3 text-center">Habilidades Gerais</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="generalSkillsChart"></canvas>
                    </div>
                    <div class="chart-editor">
                        <label>Técnica: <input type="number" class="editable-chart-value" data-chart="general" data-index="0" value="0" min="0" max="10"></label>
                        <label>Tática: <input type="number" class="editable-chart-value" data-chart="general" data-index="1" value="0" min="0" max="10"></label>
                        <label>Físico: <input type="number" class="editable-chart-value" data-chart="general" data-index="2" value="0" min="0" max="10"></label>
                        <label>Mental: <input type="number" class="editable-chart-value" data-chart="general" data-index="3" value="0" min="0" max="10"></label>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold text-lg mb-3 text-center">Competências Técnicas</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="technicalSkillsChart"></canvas>
                    </div>
                     <div class="chart-editor">
                        <label>Forehand: <input type="number" class="editable-chart-value" data-chart="technical" data-index="0" value="0" min="0" max="10"></label>
                        <label>Backhand: <input type="number" class="editable-chart-value" data-chart="technical" data-index="1" value="0" min="0" max="10"></label>
                        <label>Saque: <input type="number" class="editable-chart-value" data-chart="technical" data-index="2" value="0" min="0" max="10"></label>
                        <label>Efeito: <input type="number" class="editable-chart-value" data-chart="technical" data-index="3" value="0" min="0" max="10"></label>
                    </div>
                </div>
            </div>
        </section>

        <section id="consideracoes-avaliador" class="section-container">
            <h2 class="section-title">3. Considerações do Avaliador</h2>
            <textarea id="s3-intro" class="editable-general-text" rows="2"></textarea>
            <ul class="list-disc list-inside space-y-3 text-gray-700 mt-4">
                <li>
                    <input type="text" class="editable-list-item-title" data-id="s3-l1-title" value="Técnica:">
                    <textarea class="editable-list-item-desc" data-id="s3-l1-desc" rows="2"></textarea>
                </li>
                 <li>
                    <input type="text" class="editable-list-item-title" data-id="s3-l2-title" value="Tática:">
                    <textarea class="editable-list-item-desc" data-id="s3-l2-desc" rows="2"></textarea>
                </li>
                 <li>
                    <input type="text" class="editable-list-item-title" data-id="s3-l3-title" value="Físico:">
                    <textarea class="editable-list-item-desc" data-id="s3-l3-desc" rows="2"></textarea>
                </li>
                 <li>
                    <input type="text" class="editable-list-item-title" data-id="s3-l4-title" value="Mental:">
                    <textarea class="editable-list-item-desc" data-id="s3-l4-desc" rows="2"></textarea>
                </li>
            </ul>
        </section>

        <section id="avaliacao-detalhada" class="section-container">
            <h2 class="section-title">4. Avaliação Detalhada</h2>
            <textarea id="s4-intro" class="editable-general-text" rows="2">Aguardando processamento para gerar exemplos em vídeo...</textarea>
            
            <div id="video-examples-container" class="space-y-8">
                </div>

            <div class="button-container">
                <button class="btn-secondary" onclick="savePreliminarReport()">Atualizar Relatório Preliminar</button>
                <button class="btn-success" onclick="generateFinalReport()">Gerar Relatório Final</button>
            </div>
        </section>
    </main>
</div>

<script>
    // Moved to global scope to be accessible from onclick attribute
    const saveState = () => {
        const data = { sections: {}, videos: {}, charts: { general: [], technical: [] }, videoUrl: document.getElementById('youtube-url').value, playerLevel: document.getElementById('player-level').value, additionalData: document.getElementById('additional-data').value };
        document.querySelectorAll('.editable-general-text, .editable-table-cell, .editable-list-item-title, .editable-list-item-desc').forEach(el => { data.sections[el.id || el.dataset.id] = el.value; });
        document.querySelectorAll('.video-item').forEach(item => {
            const id = item.dataset.id;
            const container = item.querySelector('.video-container');
            if (container) {
                data.videos[id] = { title: item.querySelector('.editable-title').value, description: item.querySelector('.editable-text').value, start: toSeconds(item.querySelector('.editable-time:first-of-type').value), end: toSeconds(item.querySelector('.editable-time:last-of-type').value), examples: JSON.parse(container.dataset.videos.replace(/&apos;/g, "'") || '[]') };
            }
        });
        document.querySelectorAll('.editable-chart-value[data-chart="general"]').forEach(input => data.charts.general.push(parseFloat(input.value) || 0));
        document.querySelectorAll('.editable-chart-value[data-chart="technical"]').forEach(input => data.charts.technical.push(parseFloat(input.value) || 0));
        localStorage.setItem(storageKey, JSON.stringify(data));
    };

    const loadState = () => {
        const savedData = localStorage.getItem(storageKey);
        return savedData ? JSON.parse(savedData) : null;
    };
    
    // Final solution function in global scope
    const generateFinalReport = async () => {
        saveState();
        const dataToSave = loadState();
        if (!dataToSave) {
            alert("Nenhum dado para salvar. Processe uma análise primeiro.");
            return;
        }
        
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => button.disabled = true);
        
        const finalDoc = document.cloneNode(true);
        renderStaticReport(finalDoc, dataToSave);
        finalDoc.querySelector('title').textContent = 'Relatório de Análise Final';
        
        finalDoc.querySelectorAll('script').forEach(script => { if (!script.src || !script.src.includes('chart.js')) { script.remove(); } });
        
        const chartRenderScript = finalDoc.createElement('script');
        chartRenderScript.textContent = `
            document.addEventListener('DOMContentLoaded', () => {
                const finalData = ${JSON.stringify(dataToSave)};
                const chartOptions = {
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            pointLabels: { font: { size: 14, weight: 'bold' }, color: '#4a5568' },
                            grid: { color: 'rgba(203, 213, 225, 0.5)' },
                            ticks: { backdropColor: 'rgba(255, 255, 255, 0.8)', stepSize: 2 }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                };
                if(document.getElementById('generalSkillsChart')) { new Chart(document.getElementById('generalSkillsChart'), { type: 'radar', data: { labels: ['Técnica', 'Tática', 'Físico', 'Mental'], datasets: [{ label: 'Habilidades Gerais', data: finalData.charts.general, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2 }] }, options: chartOptions }); }
                if(document.getElementById('technicalSkillsChart')) { new Chart(document.getElementById('technicalSkillsChart'), { type: 'radar', data: { labels: ['Forehand', 'Backhand', 'Saque', 'Efeito'], datasets: [{ label: 'Competências Técnicas', data: finalData.charts.technical, backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 2 }] }, options: chartOptions }); }
                });
            `;
        finalDoc.body.appendChild(chartRenderScript);
        
        const finalHtml = '<!DOCTYPE html>\n' + finalDoc.documentElement.outerHTML;
        const apiUrl = 'https://pdf-service-859367579735.us-central1.run.app/generate-pdf';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/html'
                },
                body: finalHtml
            });
            
            if (!response.ok) {
                throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            alert(`PDF gerado e armazenado com sucesso! URL: ${result.pdf_url}`);
            window.open(result.pdf_url, '_blank');

        } catch (error) {
            console.error("Erro ao gerar o PDF:", error);
            alert("Ocorreu um erro ao gerar o relatório. Por favor, tente novamente.");
        } finally {
            const editableElements = document.querySelectorAll('input, textarea');
            editableElements.forEach(el => {
                el.disabled = true;
            });
            const buttons = document.querySelectorAll('button');
            buttons.forEach(el => {
                el.disabled = true;
                el.style.display = 'none';
            });
            const finalDocForRender = document.cloneNode(true);
            renderStaticReport(finalDocForRender, dataToSave);
            document.body.innerHTML = finalDocForRender.body.innerHTML;
        }
    };

    const savedData = loadState();
    initializePage(savedData);
});